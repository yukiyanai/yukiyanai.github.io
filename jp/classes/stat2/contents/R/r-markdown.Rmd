---
title: "統計学2"
subtitle: "Rマークダウンの使い方"
author: "矢内　勇生"
date: "2018-04-19（改訂：2019-04-19, 2019-06-03, 2020-08-18, 2021-04-16）"
output:
  pdf_document:
    latex_engine: lualatex
    toc: false
    number_sections: true
  html_document:
    highlight: textmate
    theme: united
    toc: true
    smart: false
    css: my-markdown.css
header-includes:
  - \usepackage{indentfirst}
  - \parindent = 1em
  - \usepackage{dcolumn}
  - \newcolumntype{.}{D{.}{.}{-1}}
  - \usepackage{caption}
  - \captionsetup[table]{name=表}
  - \captionsetup[figure]{name=図}
  - \usepackage{hyperref}
documentclass: bxjsarticle
classoption: 10pt,a4paper,lualatex,ja=standard
---

まず、マークダウン全体のオプション（グローバルチャンクオプション）を指定する。
PDFに出力する（LaTeX 使う）場合は、グラフィックデバイスに cairo を利用するが、HTML の場合には cairo を使いたくないので、`knitr::is_latex_output()` を利用して場合分けする。
以下のコードチャンクは、オプションに `include = FALSE` がついているので、出力されたPDFやHTML では非表示になる。
このチャンク（グローバルオプション）は**常にYAMLヘッダのすぐ下に書く**べきである。
```{r global_option, include = FALSE}
knitr::opts_chunk$set(echo = TRUE,      # Rコード: FALSE で非表示, TRUE で表示
                      warning = FALSE,  # 警告文: FALSE で非表示, TRUE で表示
                      message = TRUE,   # メッセージ: FALSE で非表示, TRUE で表示
                      fig.width = 5,    # 図の幅の既定値
                      fig.height = 3)   # 図の高さの既定値
## PDF に出力する際は cairo を使用する
if (knitr::is_latex_output()) {
  knitr::opts_chunk$set(dev = "cairo_pdf")
}
```


# 準備

Rマークダウン (R Markdown、拡張子は.Rmd) ファイルはRStudio で編集する。編集したファイルをPDF（またはHTML） に出力するために、`rmarkdown::render()` や`knitr::knit()` を利用する。これらがインストール済みでない場合はまずインストールする。
```{r install_packs, message = FALSE, eval = FALSE}
install.packages("tidyverse", dependencies = TRUE)
install.packages("rmarkdown", dependencies = TRUE) 
install.packages("knitr", dependencies = TRUE) 
install.packages("systemfonts")
install.packages("remotes")
remotes::install_github("Gedevan-Aleksizde/fontregisterer", 
                        repos = NULL, type = "source")
```   

すべてインストールできたら、パッケージを読み込む。パッケージのインストールは一度すれば済むが、`library()` を使ったパッケージの読み込みは、Rを起動するたびに行う必要がある。
ただし、**rmarkdown** パッケージと**knitr** パッケージは必要なときのみ呼び出せば良いので、`library()` では読み込まなくても良い。

```{r, message = FALSE}
library(tidyverse)
```

```{r, echo = FALSE, message = FALSE}
## 図のなかで日本語を使えるようにする
## フォントの設定はお好みで
## （Unix/Linux ではIPAexフォントのインストールが必要かも）
if (.Platform$OS.type == "windows") {
  # Windows
  require(fontregisterer)
  my_font <- "Yu Gothic"
} else if (capabilities("aqua")) {
  # macOS
  my_font <- "HiraginoSans-W3"
} else {
  # Unix/Linux
  my_font <- "IPAexGothic"
}
## ggplot2 用の設定
theme_set(theme_gray(base_size   = 9,
                     base_family = my_font))
```


# Rマークダウンの書き方・使い方

マークダウンファイル ([r-markdown.Rmd](r-markdown.Rmd)) とそのファイルを元に生成されたPDFファイル （PDFを開いているならそのファイル）([r-markdown.pdf]((r-markdown.pdf)))と htmlファイル（インターネットブラウザで読んでいるならそのファイル）（[r-markdown.html](r-markdown.html)) を見比べながら、RStudioでRマークダウンファイルを扱えるようにするのが今日の目標である。

このマークダウンをそのまま使うためには、担当教員が作ったスタイルシート（[my-markdown.css](my-markdown.css)）をプロジェクトのフォルダに保存する必要がある。
スタイル（表示されるページの見た目）をカスタマイズしたいときは、このファイルを変更すればよい。デフォルトのスタイルのままで良いとき（あまり良くないと思うが）は、ヘッダの'css'オプションの指定をやめる（このRmdファイル [htmlではない] のYAMLヘッダ部分にある `css: my-markdown.css` の行を削除する）。

この資料と同じ画像を表示するためには、画像ファイルも同じフォルダに保存する必要がある。自分でもっている画像（写真）に置き換えて試してほしい。


## マークダウン記法を利用した文章の書き方

文章は、いつもどおり書けばよい。
文章の一部をイタリック（斜字体）にしたいときは、イタリックにしたい部分を \* または \_ で挟むと、*this is italic* あるいは _this is also italic_ となる（日本語は斜字体にしない）。
太字は、\*\*（\*を2つ） または \_\_（\_ を2つ）で挟むと、**ここが太字** または __ここも太字__ となる。
太字のイタリックは、\*\*\* （\*を3つ）または \_\_\_（\_を3つ）で挟むと、***here is bold italic*** または ___here is also bold italic___ となる。

改行するときは、文章の間を1行以上空ける。

箇条書きは、\* または \_ を利用し、

* 項目1
* 項目2
  * 項目2-1
  * 項目2-2

あるいは、

- 項目1
  - 項目1-1
  - 項目1-2
- 項目2

のようにできる。\* や \- の後には半角スペースを挿入する。箇条書きを入れ子にするとき、字下げは Tab で行う

番号付きの箇条書きは、数字で作れる。

1. First item
1. Second item
    1. What?
    1. How?
1. Third item

のようにする。入力する際にすべて「1.」にしても、自動的に1, 2, 3, ... とうい番号が降られる。全部1にしておくと、後から項目の並べ替えができるので楽である。（1でなくても並べ替えるが、数字の意味が不明になる。）

ヘディング (heading) は、"\#" （ハッシュ記号） で作れる。
論文・レポートを書くときは、ヘディングを利用して文章を構造化する。
\# の数が少ないほど、上位のヘディングになる。

例を以下に示す。


# ハッシュ1つのヘディング 

## ハッシュ2つのヘディング

### ハッシュ3つのヘディング
 
#### ハッシュ4つのヘディング


論文・レポートでは、以下のようにヘディングを使い分ける。

- \#: 節（セクション, section）
- \#\#: 小節 (subsection)
- \#\#\#: 小節以下の見出し (subsubsection)
- \#\#\#\#: （あまり使わない）


また、リンクを貼ることもできる：[矢内のウェブサイト](https://yukiyanai.github.io/jp/)。

画像も貼れる：![いらすとやの猫](animal_chara_computer_neko.png){width=50%}

（出典：[いらすとや](https://www.irasutoya.com/2018/10/blog-post_67.html)）

画像へのパスが通っていないと表示されないので注意。


HTMLに出力する場合は、HTMLを直接書くこともできる（PDFに出力する場合はうまくいかない）。

- リンクを貼る：<a href="https://yukiyanai.github.io/jp/" target="_blank">矢内のウェブサイト</a>
- 画像を貼る：<img src="animal_chara_computer_neko.png" width="300">


### $\ast$ 数式の書き方

[LaTeX](https://ja.wikipedia.org/wiki/LaTeX) と同じように数式を書くこともできる。
文章中と同じ行に数式を書きたいときは、`$`で挟む。
たとえば、$\bar{x} = \sum_{i=1}^n x_i / n$ と、する。

数式を独立したブロックとして書きたいときは、`$$`で挟み、
$$
\sigma^2 = \frac{\sum_{i=1}^n (x_i - \mu)^2}{n}
$$
のようにする。


## コードチャンクの書き方

Rのコードは、コードチャンクと呼ばれる部分に書き込む。
コードチャンクは、たとえば以下のように書ける。
```{r example-chunk}
a <- 1:10
b <- -1:-10
```

Rコードチャンクの始めには、3つの「\`」の後に{r}をつける。
rとスペースの後（{}の中）には、チャンクの名前を付ける。
好きな名前を付けてよいが、他のチャンクとまったく同じ名前は付けられない。
チャンクの終わりには3つの「\`」を書く。
RStudioで開いたRマークダウンファイル内でコードチャンクを作るには、次のショートカットキーを使った方がよい。

- macOS: Cmd + Option + I
- Windows: Ctrl + Alt + I

I は Insert （チャンクを「挿入する」）の頭文字である。

文章中にRコードを書きたいときは`mean(x)` のように、Rのコマンドを\`の間に書く。
関数を実行（評価, evaluate）した後の結果を文章中に入れたいときは、「\$a\$ の平均値は \` r mean(a) \` です」のように "r" を入れて書くと、「$a$ の平均値は`r mean(a)` です」となる。つまり、mean(a) をRが計算し、その結果を文章の中に入れてくれる。この方法を使えば、文章と別にRのコマンドを実行しなくても、Rの実行結果を表示することができる。

図を含めた文章も作れる。チャンクオプション `fig.cap` で図のキャプションが指定できる。
```{r example-plot4html, fig.cap = "トマト色のヒストグラム"}
p <- tibble(x = rnorm(100, mean = 0, sd = 1)) %>% 
  ggplot(aes(x = x)) + 
  geom_histogram(binwidth = 1, color = "black", fill = "tomato") +
  labs(y = "度数", title = "ヒストグラム")
plot(p)
```

何もオプションを指定しない状態では、チャンクは1行ずつ評価され、結果も順番に次々出力される。
たとえば、
```{r sd-and-var}
sd(a)
var(a)
```

チャンクの最後まで評価してからまとめて結果表示したいときは、チャンクオプション**results** を'hold'にする。
オプションは、チャンク名の後に「,（comma）」を打ち、その後に書く。
例えば、`{r example-option, results = 'hold'}` とチャンクの冒頭に書くと、
```{r example-option, results = 'hold'}
sd(a)
var(a)
```
となる。

チャンクオプションについてより詳しくは [ココ](http://d.hatena.ne.jp/teramonagi/20130615/1371303616) などを参照されたい。

また、Rマークダウン全般（特に、RStudioを使う場合）については、[ココ](https://kazutan.github.io/JSSP2018_spring/intro_rstudio.html) を参照。

Rマークダウンのチートシート（[PDFファイル](https://github.com/rstudio/cheatsheets/raw/master/translations/japanese/)）

<br>


# R Markdown を knit してレポートを作る

## R MarkdownファイルをPDFファイルに出力する

PDFファイルを作るためにはTeXが必要である。TeXを使ったことがなく、パソコンにTeXがインストールされていない場合は、以下のコマンドを実行して **tinytex** をインストールする。それなりに時間がかかるので気長に待とう。
（**注意**：既にLaTeX環境が設定済みなら、以下のコードを実行する必要はない。）
```{r tinylatex, eval = FALSE}
install.packages("tinytex")
tinytex::install_tinytex()
```

PDFファイルに変換する際のオプションは、ヘッダ部分 （YAMLヘッダ) で指定する。このRmdファイル（HTMLファイルではない。つまり、ウェブブラウザで見ている場合には表示されていない）では、第1行から第28行までがヘッダであり、そのうち、`pdf_document:` のブロックと、`documentclass:`、`classoption:` でPDF出力のためのオプションが指定されている。例えば、`toc: true` は目次 (table of contents; toc) を表示するという指定である。非表示にするには `toc: false` とする。 

試しに、"r-markdown.Rmd" を "r-markdown.pdf" に変換してみよう。
Rmd ファイルをRStudio で編集している場合、コード編集画面の上にある "Knit" ボタン（毛糸と棒針のマーク）の右にある三角ボタンを押して、表示されたメニューから "Knit to PDF" を選べばPDFができる。初めて実行するときは、足りないパッケージを自動でインストールするので、時間がかかるかもしれない。

出力されたPDFファイルは（他のディレクトリを指定しない限り）現在の作業ディレクトリ（プロジェクトのフォルダ）に保存される。出来上がったPDFファイルをAdobe Readerやskim 等のPDFリーダで開いて確認してみよう。（RStudio のViewr だと、平仮名の「う」が表示されないが、Adobe Reader で開くと正しく表示される。）

コマンドを使っPDFファイルを作るときは、`rmarkdown::render()` を使う。

```{r render-pdf, eval = FALSE}
rmarkdown::render("r-markdown.Rmd", 
                  output_format = "pdf_document",
                  output_file = "r-markdown.pdf", 
                  run_pandoc = FALSE)
```
`run_pandoc = FALSE` を指定しないと日本語が文字化けするので注意が必要である（ボタンを押して変換するときは心配しなくてよい。ボタンで変換できればよい）。
<br>



## R MarkdownファイルをHTMLファイルに出力する

HTML ファイルに変換する際のオプションは、ヘッダ部分で指定する。このRmdファイル（HTMLファイルではない。つまり、ウェブブラウザで見ている場合には表示されていない） では、第1行から第28行までがヘッダであり、そのうち、`html_document:` のブロックでHTML出力のためのオプションが指定されている。例えば、`toc: ture` は目次 (table of contents; toc) を表示するという指定である。非表示にするには `toc: false` とする。 

試しに、"r-markdown.Rmd" を "r-markdown.html" に変換してみよう。
Knitする前に、グローバルチャンクオプション（このRmdファイルの67-74行）の中にある、
`dev = "cairo_pdf"` の先頭に `#` をつけてコメントアウトしよう。（PDFにする際には、`#`# を消してコメントからコードに戻す必要がある。）


Rmd ファイルをRStudio で編集している場合、コード編集画面の上にある "Knit" ボタン（毛糸と棒針のマーク）の右にある三角ボタンを押して、表示されたメニューから "Knit to HTML" を選べばHTMLファイルができる。

出力されたHTMLファイルは（他のディレクトリを指定しない限り）現在の作業ディレクトリ（プロジェクトのフォルダ）に保存される。
出来上がったHTMLファイルをウェブブラウザで開いて確認してみよう。

コマンドを使ってHTMLファイルを作るときは、`rmarkdown::render()` を使う。
```{r render-html, eval = FALSE}
rmarkdown::render("r-markdown.Rmd", 
                  output_format = "html_document",
                  output_file = "r-markdown.html", 
                  run_pandoc = FALSE)
```
`run_pandoc = FALSE` を指定しないと日本語が文字化けするので注意が必要である（ボタンを押して変換するときは心配しなくてよい。ボタンで変換できればよい）。



<br>
<br>
<div align="right">
[授業の内容に戻る](../)
</div>






