---
title: "統計学2"
author: "矢内　勇生"
date: '2018-04-18'
output:
  html_document:
    css: my-markdown.css
    highlight: tango
    self_contained: yes
    smart: no
    theme: united
    toc: yes
subtitle: Rマークダウン入門と2変数の記述統計
---

このページの内容を初めて読むときは、$\ast$ が付いている項目は飛ばして良い（少し上級向けの内容）。

# 準備

Rマークダウン (R Markdown、拡張子は.Rmd) ファイルはRStudio で編集する。編集したファイルをHTML（またはPDF） に出力するために、`rmarkdown::render()` や`knitr::knit()` を利用する。これらがインストール済みでない場合はインストールし、パッケージを読み込む。
```{r rmarkdown-package, message=FALSE}
# rmarkdownをインストール済みでない場合のみ 次の行の#を消して実行する
# install.packages('rmarkdown', dependencies = TRUE) 
library('rmarkdown')
# knitrをインストール済みでない場合のみ 次の行の#を消して実行する
# install.packages('knitr', dependencies = TRUE) 
library('knitr')
# devtools をインストール済みでない場合のみ 次の行の#を消して実行する
# install.packages('devtools')
devtools::install_github('yihui/knitr')
library('knitr')
```

```{r global_option, include=FALSE}
# まず、マークダウン全体のオプションを指定する
# "include = FALSE" なので、このチャンクは出力に表示されない
knitr::opts_chunk$set(warning = FALSE, echo = TRUE, message = TRUE,
                      fig.width = 6, fig.height = 5)
```

<br>

# Rマークダウンの使い方

マークダウンファイル ([r-markdown.Rmd](r-markdown.Rmd)) とそのファイルを元に生成されたhtmlファイル（インターネットブラウザで読んでいるこのファイル）（[r-markdown.html](r-markdown.html)) を見比べながら、RStudioでRマークダウンファイルを扱えるようにするのが今日の第1の目標である。

このマークダウンをそのまま使うためには、担当教員が作ったスタイルシート（[my-markdown.css](my-markdown.css)）をプロジェクトのフォルダに保存する必要がある。
スタイル（表示されるページの見た目）をカスタマイズしたいときは、このファイルを変更すればよい。デフォルトのスタイルのままでいいとき（あまり良くないと思うが）は、ヘッダの'css'オプションの指定をやめる（このRmdファイル [htmlではない] のヘッダ部分にある "css: my-markdown.css" の行を削除する）。


## マークダウン記法を利用した文書の書き方

文章は、いつもどおり書けばよい。
文章の一部をイタリック（斜字体）にしたいときは、イタリックにしたい部分を \* または \_ で挟むと、*this is italic* あるいは _this is also italic_ となる（日本語は斜字体にしない）。
太字は、\*\*（\*を2つ） または \_\_（\_ を2つ）で挟むと、**ここが太字** または __ここも太字__ となる。
太字のイタリックは、\*\*\* （\*を3つ）または \_\_\_（\_を3つ）で挟むと、***here is bold italic*** または ___here is also bold italic___ となる。

改行するときは、文章の間を1行以上空ける。

箇条書きは、\* または \_ を利用し、

 * 項目1
 * 項目2
    * 項目2-1
    * 項目2-2

あるいは、

- 項目1
    - 項目1-1
    - 項目1-2
- 項目2

のようにできる。\* や \- の後には半角スペースを挿入する。箇条書きを入れ子ににするとき、字下げはTabで行う

番号付きの箇条書きは、数字で作れる。

1. First item
2. Second item
    1. What?
    2. How?
3. Third item

のようにする。

また、リンクを貼ることもできる：[矢内のウェブサイト](http://www.yukiyanai.com/)。

```{r include=FALSE}
#画像も貼れる：![Rのロゴ](figs/Rlogo.png)
#（画像ファイルは、[ココ](http://www.r-project.org/Rlogo.png) にある）
```

### $\ast$ 数式の書き方

LaTeX と同じように数式を書くこともできる。
文章中と同じ行に数式を書きたいときは、`$`で挟む。
たとえば、$\bar{x} = \sum_{i=1}^n x_i / n$ と、する。
数式を独立したブロックとして書きたいときは、`$$`で挟み、
$$\sigma^2 = \frac{\sum_{i=1}^n (x_i - \mu)^2}{n}$$
のようにする。

## コードチャンクの書き方

Rのコードは、コードチャンクと呼ばれる部分に書き込む。
コードチャンクは、たとえば以下のように書ける。
```{r example-chunk}
a <- 1:10
b <- -1:-10
```

Rコードチャンクの始めには、3つの「\`」の後に{r}をつける。
rとスペースの後（{}の中）には、チャンクの名前を付ける。
好きな名前を付けてよいが、他のチャンクとまったく同じ名前は付けられない。
チャンクの終わりには3つの「\`」を書く。

文章中にRコードを書きたいときは`mean(x)` のように、Rのコマンドを\`の間に書く。
関数を実行（評価, evaluate）した後の結果を文章中に入れたいときは、「\$a\$ の平均値は \` r mean(a) \` です」のように"r"を入れて書くと、「$a$ の平均値は`r mean(a)` です」となる。つまり、mean(a) をRが計算し、その結果を文章の中に入れてくれる。この方法を使えば、文章と別にRのコマンドを実行しなくても、Rの実行結果を表示することができる。

図を含めた文章も作れる。
```{r example-plot4html}
a <- rnorm(100, mean = 0, sd = 1)
hist(a,main = 'aのヒストグラム', col = "gray")
```

何もオプションを指定しない状態では、チャンクは1行ずつ評価され、結果も順番に次々出力される。
たとえば、
```{r sd-and-var}
sd(a)
var(a)
```

チャンクの最後まで評価してからまとめて結果表示したいときは、チャンクオプション**results** を'hold'にする。
オプションは、チャンク名の後に「,（comma）」を打ち、その後に書く。
例えば、\`\`\` {r example-option, results='hold'} とチャンクの冒頭に書くと、
```{r example-option, results='hold'}
sd(a)
var(a)
```
となる。

チャンクオプションについてより詳しくは [ココ](http://d.hatena.ne.jp/teramonagi/20130615/1371303616) などを参照されたい。

また、Rマークダウン全般（特に、RStudioを使う場合）については、[ココ](http://rmarkdown.rstudio.com/index.html) を参照。

<br>


## R MarkdownファイルをHTMLファイルに出力する

R Markdown を HTM ファイルに出力するときは、`rmarkdown::render()`を使う。

HTML ファイルに変換する際のオプションは、ヘッダ部分で指定する。このRmdファイルでは、第1行から第14行の間がヘッダであり、そのうち、"html_document:" のブロックでHTML出力のためのオプションが指定されている。例えば、"toc: yes" は目次 (table of contents; toc) を表示するという指定である。非表示にするには "toc: no" とする。 

試しに、"r-markdown.Rmd" を "r-markdown.html" に変換してみよう。
Rmd ファイルをRStudio で編集している場合、コード編集画面の上にある "Knit" ボタン（毛糸と棒針のマーク）を押してもHTMLファイルを作れる。

出力されたHTMLファイルは（他のディレクトリを指定しない限り）現在の作業ディレクトリ（プロジェクトのフォルダ）に保存される。
出来上がったHTMLファイルをブラウザで開いて確認してみよう。

コマンドを使ってHTMLファイルを作るときは、`rmarkdown::render()` を使う。
```{r render-html, eval=FALSE}
render('r-markdown.Rmd', output_format = 'html_document',
       output_file = 'r-markdown.html', run_pandoc = FALSE)
```
**run_pandoc = FALSE** を指定しないと日本語が文字化けするので注意が必要である（ボタンを押して変換してするときは心配しなくてよい。今はボタンで変換できればよい）。
<br>


# R Markdown の例：2変数の記述統計

前回と同じ架空のデータセット [fake-data-01.csv](../data/fake-data-01.csv) を使い、2つの量的な変数の関係を調べてみよう。

前回同様、このデータセットを `myd` という名前で利用する。
```{r read_csv}
myd <- read.csv("data/fake-data-01.csv")
```

データを読み込んだら、中身を確認する。
```{r check-dataset}
head(myd)
tail(myd)
```

## 2つの量的変数の関係を図示する

2つの量的変数の関係は、散布図 (scatter plot) で確認する。ここでは、身長 (height) と体重 (weight) の関係を図示してみよう。Rでは、`plot(横軸の変数, 縦軸の変数)` で散布図ができる。

```{r scatter1}
plot(myd$height, myd$weight,
     xlab = "身長 (cm)", ylab = "体重 (kg)")
```

このデータセットに含まれる身長と体重の間には、どのような関係があるだろうか？

## 2つの量的変数の関係を統計量で示す

2つの量的変数の関係を表すのにもっともよく使われるのは、相関係数 (correlation coefficient) である。この統計量は、$r$ で表されることが多い。$-1 \leq r \leq 1$となる。$a$と$b$ という2つの変数があったとき、$a$が大きくなるほど$b$ も大きくなるという関係があるとき、「$a$と$b$には正の相関 (positive correlation) がある」と言い、このとき $r > 0$ である。また、$a$が大きくなるほど$b$ が小さくなるという関係があるとき、「$a$と$b$には負の相関 (negative correlation) がある」と言い、このとき $r < 0$ である。$r=$ のとき、「$a$と$b$は相関関係がない」と言う。

正の相関があるとき、$r$が$1$に近いほど、その関係は強い。また、負の相関があるとき、$r$が$-1$に近いほど、その関係は強い。つまり、相関関係は、相関係数の絶対値が1に近いほど強い。

Rで相関係数を求めるときは、$cor()$を使う。身長と体重の相関係数は、
```{r cor-h-w}
cor(myd$height, myd$weight)
```
である。この2変数にはどんな関係があるだろうか？

## 散布図と相関係数

2つの量的な変数の関係を調べるときは、散布図と相関係数の**両者**を使ったほうがよい。

散布図だけを使うと、本当は存在しない関係を、誤って見つけてしまうことがある。例えば、本当は相関がない2つの変数の散布図を描いたとき、描かれた点がなんとなく右肩上がりの直線の周りに集まっているように見えてしまうことがある。これは、人間がパタンを見つける能力に優れている（優れ過ぎている？）からだと考えられる。偶然できた壁のシミが人間の顔に見えてしまうことがあるというのも似たような現象である。

散布図だけに頼ると、存在しないパタンが見えてしまうことがあるので、散布図で発見したパタンが本当にあるかどうか、相関係数を求めて確かめるべきである。

反対に、相関係数だけに頼るのも危険である。相関係数は、2変数のあらゆる関係を捉えられるわけではない。相関係数が示すのは、2つの相関係数の**直線的な関係だけ**である。

例として、$x$ と$y$ という2つの変数を以下のとおり作り、相関係数を計算してみよう。
```{r cor-x-y}
x <- -10:10
y <- x^2
cor(x, y)
```

2変数と$x$と$y$の相関係数は0である。相関係数だけに頼ると、2つの変数の間には関係がないと言う結論が出せそうである。しかし、相関係数が低くても、必ず散布図を描いたほうがよい。散布図を作ってみよう。
```{r plot-x-y}
plot(x, y)
```

この図を見て、$x$と$y$は無関係と言えるだろうか？

散布図から明らか（$y$をどのように作ったかを見ればもっと明らかだが）なように、$x$と$y$には強い関係がある（$y$は$x$の関数である）。しかし、その関係は**曲線的** なので、**直線的な関係しか捉えられない相関係数**は、強い関係を見落としてしまうのである。

このように、2つの量的変数の関係を調べるときは、**散布図と相関係数の両方を確認する**習慣を身につけたほうがよい。

# 課題1

[fake-data-20180418.csv](../data/fake-data-20180418.csv) を使い、以下を実行しなさい。

1. 身長 (height) の平均値、中央値、分散、標準偏差を求めなさい。
2. 体重 (weight) の平均値、中央値、分散、標準偏差を求めなさい。
3. 身長のヒストグラムと体重のヒストグラムを作りなさい。横軸と縦軸に適切なラベルをつけること。
4. 身長と体重の散布図を作りなさい。
5. 身長と体重の相関係数を求めなさい。
6. 散布図と相関係数から、このデータセット内の身長と体重にはどのような関係があるか述べなさい。

**注意：** RStudioで作った図は、図の上にある "Export"ボタンを押し、"Save as Image" または "Save as PDF" を選ぶと、名前をつけて保存することができる。

- 提出期限：来週木曜（4月26日）の授業開始時
- 結果をまとめて印刷したものを提出
- 氏名（ふりがな付き）と学籍番号を忘れずに書く
- 2枚以上（片面印刷で2ページ以上または両面印刷で3ページ以上）提出するときは、すべての紙をホチキス等で綴じること
- **Rマークダウンを使い、RマークダウンからHTMLに出力した結果を印刷した場合は加点する。**

<br>
<br>
<div align="right">
[授業の内容に戻る](../)
</div>
